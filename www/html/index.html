<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<link rel="stylesheet" href="styles.css">
<script type="text/javascript" src="includeHTML.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="60">
    <title>Brannhaugen 17</title>
</head>
<body>
<div class="container">
</div>
<script>
    async function getURL(url) {
        try {
            let res = await fetch(url);
            return await res.json();
        } catch (error) {
            console.log('Failed to fetch: ', url, error);
            const errorRes = '{"url":"' + url + '", "date": null, "error":"' + error + '"}';
            return JSON.parse(errorRes);
        }
    }

    async function renderUsers() {
        let deviceListURL = '/devices.json';
        let deviceList = await getURL(deviceListURL);
        let deviceLength = deviceList.length;
        console.log('Got: ' ,deviceList, '  with ', deviceLength, 'entries');

        let inverterURL = '/inverter.json'
        let inverter = await getURL(inverterURL);
        console.log(inverter);
        inverter.currentPower = '';
        inverter.currentPowerUnit = '';
        inverter.dayEnergy = inverter.Body.Data.DAY_ENERGY.Value;
        inverter.dayEnergyUnit = inverter.Body.Data.DAY_ENERGY.Unit;
        switch (true) {
            case inverter.Body.Data.DeviceStatus.StatusCode === 7:
                inverter.text = 'Running';
                inverter.currentPower = inverter.Body.Data.PAC.Value;
                inverter.currentPowerUnit = inverter.Body.Data.PAC.Unit;
                break;
            case inverter.Body.Data.DeviceStatus.StatusCode >= 0 && inverter.Body.Data.DeviceStatus.StatusCode <= 6:
                inverter.text = 'Startup';
                break;
            case inverter.Body.Data.DeviceStatus.StatusCode === 8:
                inverter.text = 'Standby';
                break;
            case inverter.Body.Data.DeviceStatus.StatusCode === 9:
                inverter.text = 'Boot loading';
                break;
            case inverter.Body.Data.DeviceStatus.StatusCode === 10:
                inverter.text = 'Error ';
                break;
            default:
                inverter.text = 'Unknown status: ' + inverter.Body.Data.DeviceStatus.StatusCode;
                break;
        }

        let html = '<div class="split left">';
        let htmlSegmentLeft = `
			<h4>Links</h4>
            <div class="text"><a href='http://192.168.1.23/suntime.log'>Time for sunrise and sunset</a></div>
            <div class="text"><a href='http://192.168.1.23/market.log'>High prices</a></div>
            <div class="text"><img src="http://192.168.1.23/plot.png" height="200" width="300" alt="plot of prices"></div>

            <h5>Inverter ${inverter.Head.Timestamp}</h5>
            <div class="inverter">Status ${inverter.text}</div>
            <div class="inverter">Current Power ${inverter.currentPower} ${inverter.currentPowerUnit}</div>
            <div class="inverter">Todays production ${inverter.dayEnergy} ${inverter.dayEnergyUnit}</div>`;
        html += htmlSegmentLeft ;
        html += '</div>';

        // loop through the device list
        let htmlSegmentMid = `<div class="split mid">`
        for (let i = 0; i < deviceLength; i++){
            let deviceURL = 'http://' + deviceList[i].address + '/temperature.json';
            let response = await getURL(deviceURL);
            console.log(response);

            let htmlSegmentBuild =
                `<h5>${deviceList[i].name}&nbsp; ${response.date}</h5>`
                + `<div class="temperature">Temperature <a href=${deviceURL}>${response.temperature}</a></div>`;
            if(response.hasOwnProperty('motorA')){
                htmlSegmentBuild += `<div class="motor">Motor A <a href=${deviceURL}>${response.motorA}</a></div>`;
            }
            if(response.hasOwnProperty('motorB')){
                htmlSegmentBuild += `<div class="motor">Motor B <a href=${deviceURL}>${response.motorB}</a></div>`;
            }
            if(response.hasOwnProperty('pinA')){
                htmlSegmentBuild += `<div class="pin">Pin A <a href=${deviceURL}>${response.pinA}</a></div>`;
            }
            if(response.hasOwnProperty('pinB')){
                htmlSegmentBuild += `<div class="pin">Pin B <a href=${deviceURL}>${response.pinB}</a></div>`;
            }
            if(response.hasOwnProperty('fan')){
                htmlSegmentBuild += `<div class="motor">Fan <a href=${deviceURL}>${response.fan}</a></div>`;
            }
            if(response.hasOwnProperty('power')){
                htmlSegmentBuild += `<div class="motor">Power <a href=${deviceURL}>${response.power}</a></div>`;
            }
            if(response.hasOwnProperty('daylight')){
                htmlSegmentBuild += `<div class="pin">Daylight <a href=${deviceURL}>${response.daylight}</a></div>`;
            }
            htmlSegmentMid += htmlSegmentBuild;
        }
        html += htmlSegmentMid;
        html += '</div>';

        let htmlSegmentRight = `<div class="split right">
                       <h4>Driveway</h4>
                       <div class="cam"><img src="http://192.168.1.233/test_0.jpeg" height="640" width="800" alt="drive way"></div>
                       </div>`;
        html += htmlSegmentRight;

        let container = document.querySelector('.container');
        container.innerHTML = html;
    }
    renderUsers();
</script>
</body>
</html>

